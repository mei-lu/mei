---
import { applyPostFilters, groupPostsByMonth } from "../../scripts/garden"
import { CATEGORIES, MONTHS, type PostCategory } from "../../scripts/_types"

export const prerender = false

type postQuery = {
    year?: number
    categories?: PostCategory[]
    search?: string
}

const year = Astro.url.searchParams.get("year")
const categories = Astro.url.searchParams.getAll("categories")
const search = Astro.url.searchParams.get("search")
const query: postQuery = {}

if (year) {
    query.year = Number(year)
}

if (categories.length > 0) {
    const validCategories = categories.filter(
        (category): category is PostCategory =>
            CATEGORIES.includes(category as PostCategory)
    )

    query.categories = validCategories
}

if (search) {
    query.search = search
}

const postResults = await applyPostFilters(query)
---

{JSON.stringify(postResults)}
